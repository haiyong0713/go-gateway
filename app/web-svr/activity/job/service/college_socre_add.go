package service

import (
	"context"
	"go-common/library/log"
	"go-common/library/net/trace"
	"strconv"
	"time"
)

var collegeScoreAutoCtx context.Context

func collegeScoreAutoCtxInit() {
	collegeScoreAutoCtx = trace.SimpleServerTrace(context.Background(), "collegeScoroAuto")
}

const collegeAutoID = "'85755','86157','86952','86968','86983','86929','86936','86938','86969','86989','86950','86991','86967','86945','86947','86957','86932','86931','86959','86930','86926','86320','85591','86365','85969','85590','85968','85592','86364','86920','86217','86050','84944','86809','84784','85959','85960','85823','85822','85579','84777','84776','84768','84774','86461','84769','85821','84780','84783','87136','87206','86712','84779','86713','86212','84772','84778','84676','84771','87468','86214','87466','84789','84788','84786','85099','86581','86299','87312','87338','87331','85091','86293','85104','84947','85665','85534','84915','84912','84918','86505','86486','86490','86502','86499','84749','84697','85299','84730','84739','84694','84680','84732','84681','84690','84688','84719','84941','84687','84713','84711','84939','84684','84707','84682','84712','84693','84745','85298','84677','86519','85109','86229','86923','86924','86922','85743','85744','85742','84829','85479','85377','84756','87576','85376','85057','85059','85055','85056','86148','86109','86140','86141','86126','86143','86110','86128','86113','86112','86130','86139','86124','86121','86116','86145','86106','86107','86146','85921','87140','85074','85073','86302','86306','86308','86150','85507','85505','84861','84862','84868','87392','84639','84632','85988','85975','85973','85065','85917','86995','85615','85606','85598','85597','85607','85605','85521','85067','87078','87059','87084','87470','87060','87091','87102','87086','87109','123036','87233','86921','86347','86357','86337','86342','86351','86344','86345','86349','87205','87170','87147','87150','87153','87173','87164','87163','87203','87145','86790','86788','86521','87377','87379','87380','84612','84610','84582','84602','84554','84561','84558','84589','84571','84578','84576','84551','85424','84750','86682','86635','86648','86664','86621','86627','86629','86662','86634','86643','86639','86622','86614','86651','86731','86755','86774','86732','86733','86754','86728','85070','86042','86046','85512','85014','85004','84960','84967','84962','84979','84949','84998','84976','85013','84951','84952','84972','85051','85050','85020','85026','85152','85117','85143','85137','85132','86012','86195','86192','87021','87015','86999','87008','86202','85528','87240','87290','86294','85066','86609','87358','87355','85168','85165','85770','85775','85790','85787','85773','85792','85809','85077','86058','85748','86065','86089','86071','86079','86290','86253','86264','86270','86261','86257','86232','86448','86438','86449','86445','86447','86440','86452','85319','85355','85320','85330','85327','85361','85341','85353','85346','85348','85344','85475','85458','85433','85434','85435','85440','85438','85463','85457','85455','85451','85452','85431','85430','86053','86685','85496','85495','86567','87405','87406','87455','87463','87410','87440','87454','87411','87418','87415','87447','87450','87437','87436','87408','85272','85280','84643','86054','85084','85086','85088','84759','87400','87395','85692','85698','85712','85911','85875','85905','85835','85836','85851','85848','85845','85886','85899','85871','85866','85868','85838','85927','86696','86695','120184','86699','85418','85192','84905','87031','84668','84670','86198','85396','87229','84818','84817','84802','84814','84795','84808','87388','86578','85097','86160','86170','84844','86188','86906','86903','86905','84936','86907','84935','87120','87121','87124','87472','87473','87128','87129','87126','87122','86875','86894','86867','86865','86872','86880','86860','86887','86878','86901','87119','85539','85207','86221','86384','86387','86410','86400','86802','86010','85315','85923','85566','85547','85553','85557','85563','87503','87529','87480','87491','87521','87526','87510','87533','86097','86918','86020','86029','85815','87474','85954','85947','84840','84837','86842','86833','84830','86602','86590','86600','86599','86542','85082','84762','84760','86584','85746','85481','85664','85628','85638','86585','85671','84833'"

// CollegeScoreAuto 开学季用户积分写回
func (s *Service) CollegeScoreAuto() {
	s.collegeScoreAutoRunning.Lock()
	defer s.collegeScoreAutoRunning.Unlock()
	start := time.Now()
	collegeScoreAutoCtxInit()
	log.Errorc(collegeScoreAutoCtx, "collegeScoreAuto start (%d)", start.Unix())
	if s.c.College.AutoAddScore == nil {
		return
	}
	if err := s.updateCollegeScore(collegeScoreAutoCtx); err != nil {
		return
	}
	log.Errorc(collegeScoreAutoCtx, "collegeScoreAuto success()")

}

// updateCollegeScore ...
func (s *Service) updateCollegeScore(c context.Context) error {
	hour := time.Now().Hour()
	week := time.Now().Weekday()
	hourstr := strconv.Itoa(hour)
	weekInt := int(week)
	weekStr := strconv.Itoa(weekInt)
	score, ok := s.c.College.AutoAddScore[weekStr+"_"+hourstr]
	if !ok {
		return nil
	}
	if _, err := s.college.UpdateCollegeScore(c, collegeAutoID, score); err != nil {
		log.Errorc(c, "s.college.UpdateCollegeScore err(%v)", err)
		return err
	}
	return nil
}
